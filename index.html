<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›è»¢å¯¿å¸å‰²ã‚Šå‹˜ç²¾ç®—ãƒ„ãƒ¼ãƒ«</title>
    <style>
        :root {
            --primary-color: #007bff;
            --primary-hover: #0056b3;
            --danger-color: #dc3545;
            --danger-hover: #a71d2a;
            --bg-color: #f4f7f6;
            --card-bg: #ffffff;
            --text-color: #333;
            --border-radius: 8px;
            --spacing: 16px;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: var(--card-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--bg-color);
            padding-bottom: 10px;
        }

        h1 {
            margin: 0;
            font-size: 1.5rem;
            color: var(--primary-color);
        }

        h2 {
            font-size: 1.2rem;
            margin-bottom: 15px;
            border-left: 4px solid var(--primary-color);
            padding-left: 10px;
        }

        section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: var(--border-radius);
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        input[type="text"],
        input[type="number"],
        select,
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            /* Prevents zoom on mobile */
        }

        .row {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }

        .row input {
            flex: 1;
        }

        button {
            cursor: pointer;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            font-size: 1rem;
            transition: background-color 0.2s;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            width: 100%;
        }

        .btn-primary:hover {
            background-color: var(--primary-hover);
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
            padding: 5px 15px;
            font-size: 0.9rem;
        }

        .btn-remove {
            background-color: var(--danger-color);
            color: white;
            padding: 5px 10px;
        }

        .btn-reset {
            background-color: var(--danger-color);
            color: white;
            width: 100%;
            margin-top: 20px;
        }

        .plate-inputs-container {
            display: grid;
            gap: 20px;
        }

        .participant-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
        }

        .participant-card h3 {
            margin-top: 0;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
            margin-bottom: 10px;
        }

        .plate-count-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .plate-count-row label {
            margin-bottom: 0;
            flex: 2;
        }

        .plate-count-row input {
            flex: 1;
            text-align: right;
        }

        .result-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .result-table th,
        .result-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        .result-table th {
            background-color: #f2f2f2;
        }

        #walicaOutput {
            height: 100px;
            font-family: monospace;
        }

        /* Mobile Adjustments */
        @media (max-width: 600px) {
            body {
                padding: 10px;
            }

            .container {
                padding: 15px;
            }
        }
    </style>
</head>

<body>

    <div class="container">
        <header>
            <h1>ğŸ£ å›è»¢å¯¿å¸å‰²ã‚Šå‹˜ãã‚“</h1>
        </header>

        <!-- 1. çš¿ä¾¡æ ¼è¨­å®š -->
        <section id="priceConfig">
            <h2>1. çš¿ã®ä¾¡æ ¼è¨­å®š</h2>
            <div id="plateTypesContainer">
                <!-- JS will render rows here -->
            </div>
            <button class="btn-secondary" onclick="addPlateType()">ï¼‹ çš¿ã®ç¨®é¡ã‚’è¿½åŠ </button>
        </section>

        <!-- 2. å‚åŠ è€…ç™»éŒ² -->
        <section id="participantsConfig">
            <h2>2. å‚åŠ è€…ç™»éŒ²</h2>
            <div id="participantsContainer">
                <!-- JS will render rows here -->
            </div>
            <button class="btn-secondary" onclick="addParticipant()">ï¼‹ å‚åŠ è€…ã‚’è¿½åŠ </button>
        </section>

        <!-- 3. çš¿æšæ•°å…¥åŠ› -->
        <section id="plateCounts">
            <h2>3. é£Ÿã¹ãŸçš¿ã®æšæ•°</h2>
            <p style="font-size: 0.9rem; color: #666; margin-bottom: 15px;">â€» 1.ã¨2.ã‚’å…¥åŠ›ã™ã‚‹ã¨è¡¨ç¤ºã•ã‚Œã¾ã™</p>
            <div id="plateInputsContainer" class="plate-inputs-container">
                <!-- JS will render cards here -->
            </div>
        </section>

        <!-- 4. æ”¯æ‰•è€…é¸æŠ -->
        <section id="payerSelection">
            <h2>4. æ”¯æ‰•è€…ã‚’é¸æŠ</h2>
            <div class="form-group">
                <select id="payerSelect">
                    <option value="">-- ä¼šè¨ˆã—ãŸäººã‚’é¸ã‚“ã§ãã ã•ã„ --</option>
                </select>
            </div>
        </section>

        <!-- è¨ˆç®—ãƒœã‚¿ãƒ³ -->
        <button class="btn-primary" onclick="calculate()">è¨ˆç®—ã™ã‚‹</button>

        <!-- 5. çµæœè¡¨ç¤º -->
        <section id="results" style="margin-top: 30px; display: none;">
            <h2>5. è¨ˆç®—çµæœ</h2>
            <table class="result-table">
                <thead>
                    <tr>
                        <th>åå‰</th>
                        <th>åˆè¨ˆé‡‘é¡</th>
                    </tr>
                </thead>
                <tbody id="resultTableBody">
                </tbody>
            </table>

            <h3>Walicaå…¥åŠ›ç”¨ãƒ†ã‚­ã‚¹ãƒˆ</h3>
            <textarea id="walicaOutput" readonly onclick="this.select()"></textarea>
        </section>

        <footer>
            <button class="btn-reset" onclick="resetAll()">å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
        </footer>
    </div>

    <script>
        // --- State ---
        let plateTypes = [];

        let participants = [];

        // Structure: { participantId: { plateTypeId: count, ... }, ... }
        let counts = {};

        // --- DOM Elements ---
        const plateTypesContainer = document.getElementById('plateTypesContainer');
        const participantsContainer = document.getElementById('participantsContainer');
        const plateInputsContainer = document.getElementById('plateInputsContainer');
        const payerSelect = document.getElementById('payerSelect');
        const resultsSection = document.getElementById('results');
        const resultTableBody = document.getElementById('resultTableBody');
        const walicaOutput = document.getElementById('walicaOutput');

        // --- Render Functions ---

        function renderPlateTypes() {
            plateTypesContainer.innerHTML = '';
            plateTypes.forEach((plate, index) => {
                const div = document.createElement('div');
                div.className = 'row';
                div.innerHTML = `
                <input type="text" placeholder="è‰²ãƒ»ç¨®é¡" value="${plate.name}" onchange="updatePlateName(${index}, this.value)">
                <input type="number" placeholder="ä¾¡æ ¼" value="${plate.price}" onchange="updatePlatePrice(${index}, this.value)">
                <button class="btn-remove" onclick="removePlateType(${index})">Ã—</button>
            `;
                plateTypesContainer.appendChild(div);
            });
            renderPlateInputs(); // Update inputs when config changes
        }

        function renderParticipants() {
            participantsContainer.innerHTML = '';
            payerSelect.innerHTML = '<option value="">-- ä¼šè¨ˆã—ãŸäººã‚’é¸ã‚“ã§ãã ã•ã„ --</option>'; // Reset payer options

            participants.forEach((p, index) => {
                // Participant Input Row
                const div = document.createElement('div');
                div.className = 'row';
                div.innerHTML = `
                <input type="text" placeholder="åå‰" value="${p.name}" onchange="updateParticipantName(${index}, this.value)">
                <button class="btn-remove" onclick="removeParticipant(${index})">Ã—</button>
            `;
                participantsContainer.appendChild(div);

                // Add to Payer Select
                const option = document.createElement('option');
                option.value = p.id;
                option.textContent = p.name;
                payerSelect.appendChild(option);
            });
            renderPlateInputs();
        }

        function renderPlateInputs() {
            plateInputsContainer.innerHTML = '';
            participants.forEach(p => {
                const card = document.createElement('div');
                card.className = 'participant-card';

                let html = `<h3>${p.name}</h3>`;

                plateTypes.forEach(plate => {
                    const count = (counts[p.id] && counts[p.id][plate.id]) || 0;
                    html += `
                    <div class="plate-count-row">
                        <label>${plate.name} (${plate.price}å††)</label>
                        <input type="number" min="0" value="${count}" 
                            onchange="updateCount(${p.id}, ${plate.id}, this.value)"
                            onclick="this.select()">
                    </div>
                `;
                });
                card.innerHTML = html;
                plateInputsContainer.appendChild(card);
            });
        }

        // --- Logic Functions ---

        function addPlateType() {
            const id = Date.now();
            plateTypes.push({ id, name: 'æ–°è¦çš¿', price: 100 });
            renderPlateTypes();
        }

        function removePlateType(index) {
            if (confirm('ã“ã®çš¿ã®ç¨®é¡ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                plateTypes.splice(index, 1);
                renderPlateTypes();
            }
        }

        function updatePlateName(index, val) {
            plateTypes[index].name = val;
            renderPlateInputs(); // Re-render labels
        }

        function updatePlatePrice(index, val) {
            plateTypes[index].price = parseInt(val) || 0;
            renderPlateInputs(); // Re-render labels
        }

        function addParticipant() {
            const id = Date.now();
            participants.push({ id, name: `å‚åŠ è€…${participants.length + 1}` });
            renderParticipants();
        }

        function removeParticipant(index) {
            if (confirm('ã“ã®å‚åŠ è€…ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                const pId = participants[index].id;
                delete counts[pId];
                participants.splice(index, 1);
                renderParticipants();
            }
        }

        function updateParticipantName(index, val) {
            participants[index].name = val;
            renderParticipants(); // Re-render payer select and headers
        }

        function updateCount(pId, plateId, val) {
            if (!counts[pId]) counts[pId] = {};
            counts[pId][plateId] = parseInt(val) || 0;
        }

        function calculate() {
            const payerId = payerSelect.value;
            if (!payerId) {
                alert('ä¼šè¨ˆã—ãŸäººã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            const payer = participants.find(p => p.id == payerId);
            if (!payer) {
                alert('ç„¡åŠ¹ãªä¼šè¨ˆè€…ã§ã™ã€‚');
                return;
            }

            let results = [];
            let walicaLines = [];

            participants.forEach(p => {
                let total = 0;
                // Calculate total for this participant
                if (counts[p.id]) {
                    for (const [plateId, count] of Object.entries(counts[p.id])) {
                        const plate = plateTypes.find(pl => pl.id == plateId);
                        if (plate) {
                            total += plate.price * count;
                        }
                    }
                }
                results.push({ name: p.name, total: total, isPayer: p.id == payerId });

                // Walica String Generation
                // "Payer pays for Participant Amount"
                // If p is payer, skip (unless you want to record their own cost, but normally Walica handles "debt")
                // Requirement says: "AãŒBã®åˆ†â—‹â—‹å††æ”¯æ‰•ã„" (A pays for B's share)
                if (p.id != payerId && total > 0) {
                    walicaLines.push(`${payer.name}ãŒ${p.name}ã®åˆ†${total}å††æ”¯æ‰•ã„`);
                }
            });

            // Display Results
            resultTableBody.innerHTML = '';
            results.forEach(r => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                <td>${r.name} ${r.isPayer ? ' (æ”¯æ‰•)' : ''}</td>
                <td>${r.total.toLocaleString()} å††</td>
            `;
                if (r.isPayer) {
                    tr.style.fontWeight = 'bold';
                    tr.style.backgroundColor = '#e3f2fd';
                }
                resultTableBody.appendChild(tr);
            });

            walicaOutput.value = walicaLines.join('\n');
            resultsSection.style.display = 'block';

            // Scroll to results
            resultsSection.scrollIntoView({ behavior: 'smooth' });
        }

        function resetAll() {
            if (confirm('å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                plateTypes = [];
                participants = [];
                counts = {};

                renderPlateTypes();
                renderParticipants();
                resultsSection.style.display = 'none';
            }
        }

        // --- Init ---
        renderPlateTypes();
        renderParticipants();

    </script>

</body>

</html>